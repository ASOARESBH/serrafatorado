<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Morador - Serra da Liberdade</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.3s;
        }
        .loading-screen.hide { opacity: 0; pointer-events: none; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff;
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: #fff; margin-top: 1rem; font-size: 1.1rem; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: #fff; padding: 1.5rem 2rem; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .header-content {
            max-width: 1200px; margin: 0 auto; display: flex;
            justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 1.5rem; }
        .header h1 i { margin-right: 0.5rem; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-name { font-size: 0.95rem; }
        .btn-logout {
            background: rgba(255, 255, 255, 0.2); padding: 0.5rem 1rem;
            border: none; border-radius: 8px; color: #fff; cursor: pointer; transition: 0.2s;
        }
        .btn-logout:hover { background: rgba(255, 255, 255, 0.3); }
        
        /* Container */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        
        /* Tabs */
        .tabs {
            display: flex; gap: 0.5rem; margin-bottom: 2rem; background: #fff;
            padding: 0.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .tab {
            flex: 1; padding: 1rem; border: none; background: transparent;
            color: #64748b; font-weight: 600; cursor: pointer; border-radius: 8px;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .tab:hover { background: #f8fafc; }
        .tab.active { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: #fff; }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Card */
        .card {
            background: #fff; padding: 2rem; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); margin-bottom: 1.5rem;
        }
        .card h2 { color: #1e293b; margin-bottom: 1rem; font-size: 1.3rem; }
        .card p { color: #64748b; line-height: 1.6; }
        
        /* Form */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label {
            display: block; margin-bottom: 0.5rem; color: #475569;
            font-weight: 500; font-size: 0.95rem;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0;
            border-radius: 10px; font-size: 0.95rem; transition: all 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        
        /* Buttons */
        .btn {
            padding: 0.875rem 1.5rem; border: none; border-radius: 10px;
            font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: #fff;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3); }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff;
        }
        .btn-secondary {
            background: #e2e8f0; color: #475569;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Alert */
        .alert {
            padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;
            font-size: 0.9rem; display: none; animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .alert.show { display: block; }
        .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .alert-success { background: #dcfce7; color: #166534; border-left: 4px solid #22c55e; }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.875rem; text-align: left; border-bottom: 1px solid #f1f5f9; }
        th { background: #f8fafc; font-weight: 600; color: #475569; }
        tr:hover { background: #f8fafc; }
        
        /* Badge */
        .badge {
            padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;
            font-weight: 500; display: inline-block;
        }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        
        /* Info Grid */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .info-item { background: #f8fafc; padding: 1rem; border-radius: 8px; }
        .info-label { font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem; }
        .info-value { font-size: 1.1rem; font-weight: 600; color: #1e293b; }
        
        /* Empty State */
        .empty-state {
            text-align: center; padding: 3rem 1rem; color: #94a3b8;
        }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 1rem; }
            .header-content { flex-direction: column; gap: 1rem; }
            .tabs { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
    <script src="js/sessao_manager.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Verificando sess√£o...</div>
    </div>

    <!-- Header -->
    <header class="header" style="display:none;" id="mainHeader">
        <div class="header-content">
            <h1><i class="fas fa-home"></i> Portal do Morador</h1>
            <div class="user-info">
                <span class="user-name"><i class="fas fa-user"></i> <span id="nomeUsuario">Carregando...</span></span>
                <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </div>
    </header>

    <!-- Container -->
    <div class="container" style="display:none;" id="mainContainer">
        <div id="alertContainer"></div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="abrirAba('perfil')">
                <i class="fas fa-user"></i> Meu Perfil
            </button>
            <button class="tab" onclick="abrirAba('visitantes')">
                <i class="fas fa-users"></i> Visitantes
            </button>
            <button class="tab" onclick="abrirAba('acessos')">
                <i class="fas fa-qrcode"></i> Acessos
            </button>
            <button class="tab" onclick="abrirAba('protocolos')">
                <i class="fas fa-box"></i> Protocolos
            </button>
            <button class="tab" onclick="abrirAba('hidrometro')">
                <i class="fas fa-tint"></i> Hidr√¥metro
            </button>
        </div>
        
        <!-- ABA: PERFIL -->
        <div id="perfil" class="tab-content active">
            <div class="card">
                <h2><i class="fas fa-user-circle"></i> Meus Dados</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Nome Completo</div>
                        <div class="info-value" id="perfilNome">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">CPF</div>
                        <div class="info-value" id="perfilCpf">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Unidade</div>
                        <div class="info-value" id="perfilUnidade">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">E-mail</div>
                        <div class="info-value" id="perfilEmail">-</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-phone"></i> Atualizar Telefones</h2>
                <form id="formTelefone" onsubmit="atualizarTelefone(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="telefone">Telefone Fixo</label>
                            <input type="text" id="telefone" placeholder="(31) 3333-3333">
                        </div>
                        <div class="form-group">
                            <label for="celular">Celular</label>
                            <input type="text" id="celular" placeholder="(31) 99999-9999">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Telefones
                    </button>
                </form>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-lock"></i> Alterar Senha</h2>
                <form id="formSenha" onsubmit="alterarSenha(event)">
                    <div class="form-group">
                        <label for="senhaAtual">Senha Atual</label>
                        <input type="password" id="senhaAtual" required>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="senhaNova">Nova Senha</label>
                            <input type="password" id="senhaNova" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="senhaConfirmar">Confirmar Nova Senha</label>
                            <input type="password" id="senhaConfirmar" required minlength="6">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-key"></i> Alterar Senha
                    </button>
                </form>
            </div>
        </div>
        
        <!-- ABA: VISITANTES -->
        <div id="visitantes" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-user-plus"></i> Cadastrar Visitante</h2>
                <form id="formVisitante" onsubmit="cadastrarVisitante(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="visitanteNome">Nome Completo *</label>
                            <input type="text" id="visitanteNome" required>
                        </div>
                        <div class="form-group">
                            <label for="visitanteTipoDoc">Tipo de Documento *</label>
                            <select id="visitanteTipoDoc" required>
                                <option value="CPF">CPF</option>
                                <option value="RG">RG</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="visitanteDoc">Documento *</label>
                            <input type="text" id="visitanteDoc" required>
                        </div>
                        <div class="form-group">
                            <label for="visitanteTelefone">Telefone</label>
                            <input type="text" id="visitanteTelefone">
                        </div>
                        <div class="form-group">
                            <label for="visitanteCelular">Celular</label>
                            <input type="text" id="visitanteCelular">
                        </div>
                        <div class="form-group">
                            <label for="visitanteEmail">E-mail</label>
                            <input type="email" id="visitanteEmail">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="visitanteObs">Observa√ß√£o</label>
                        <textarea id="visitanteObs" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Cadastrar Visitante
                    </button>
                </form>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-list"></i> Meus Visitantes</h2>
                <p style="color: #64748b; margin-bottom: 1rem;">Visitantes cadastrados para sua unidade. Para gerar QR Code, acesse a aba "Acessos".</p>
                <div id="listaVisitantes"></div>
            </div>
        </div>
        
        <!-- ABA: ACESSOS -->
        <div id="acessos" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-qrcode"></i> Gerar QR Code para Visitante</h2>
                <p style="color: #64748b; margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i> <strong>Importante:</strong> Um visitante s√≥ pode ter um acesso ativo por vez em todo o sistema.
                </p>
                
                <form id="formAcesso" onsubmit="salvarAcesso(event)">
                    <div class="form-grid">
                        <div>
                            <label for="acessoVisitante">Visitante *</label>
                            <select id="acessoVisitante" required>
                                <option value="">Selecione um visitante</option>
                            </select>
                        </div>
                        <div>
                            <label for="acessoTipo">Tipo *</label>
                            <select id="acessoTipo" required>
                                <option value="visitante">Visitante</option>
                                <option value="prestador">Prestador de Servi√ßo</option>
                            </select>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 1rem; margin-bottom: 0.75rem; font-size: 1rem; color: #475569;"><i class="fas fa-car"></i> Dados do Ve√≠culo</h3>
                    <div class="form-grid form-grid-3">
                        <div>
                            <label for="acessoPlaca">Placa</label>
                            <input type="text" id="acessoPlaca" placeholder="ABC-1234" maxlength="8" style="text-transform: uppercase;">
                        </div>
                        <div>
                            <label for="acessoModelo">Modelo</label>
                            <input type="text" id="acessoModelo" placeholder="Ex: Gol">
                        </div>
                        <div>
                            <label for="acessoCor">Cor</label>
                            <input type="text" id="acessoCor" placeholder="Ex: Preto">
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 1rem; margin-bottom: 0.75rem; font-size: 1rem; color: #475569;"><i class="fas fa-calendar"></i> Per√≠odo</h3>
                    <div class="form-grid">
                        <div>
                            <label for="acessoDataInicial">Data Inicial *</label>
                            <input type="date" id="acessoDataInicial" required>
                        </div>
                        <div>
                            <label for="acessoDataFinal">Data Final *</label>
                            <input type="date" id="acessoDataFinal" required>
                        </div>
                    </div>
                    
                    <div id="acessoDias" style="display:none; text-align:center; padding:1rem; background:#f1f5f9; border-radius:8px; margin:1rem 0;">
                        <div style="font-size:2rem; font-weight:bold; color:#3b82f6;" id="acessoDiasNumero">0</div>
                        <div style="color:#64748b;">dias de perman√™ncia</div>
                    </div>
                    
                    <h3 style="margin-top: 1rem; margin-bottom: 0.75rem; font-size: 1rem; color: #475569;"><i class="fas fa-door-open"></i> Tipo de Acesso *</h3>
                    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:1rem;">
                        <label style="border:2px solid #e2e8f0; padding:1rem; border-radius:8px; cursor:pointer; text-align:center;" onclick="selecionarTipoAcessoPortal('portaria')">
                            <input type="radio" name="acessoTipoAcesso" value="portaria" required style="display:none;">
                            <div style="font-size:2rem; color:#3b82f6; margin-bottom:0.5rem;"><i class="fas fa-door-open"></i></div>
                            <div style="font-weight:600;">Portaria</div>
                        </label>
                        <label style="border:2px solid #e2e8f0; padding:1rem; border-radius:8px; cursor:pointer; text-align:center;" onclick="selecionarTipoAcessoPortal('externo')">
                            <input type="radio" name="acessoTipoAcesso" value="externo" required style="display:none;">
                            <div style="font-size:2rem; color:#f59e0b; margin-bottom:0.5rem;"><i class="fas fa-road"></i></div>
                            <div style="font-weight:600;">Externo</div>
                        </label>
                        <label style="border:2px solid #e2e8f0; padding:1rem; border-radius:8px; cursor:pointer; text-align:center;" onclick="selecionarTipoAcessoPortal('lagoa')">
                            <input type="radio" name="acessoTipoAcesso" value="lagoa" required style="display:none;">
                            <div style="font-size:2rem; color:#10b981; margin-bottom:0.5rem;"><i class="fas fa-water"></i></div>
                            <div style="font-weight:600;">Lagoa</div>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="margin-top:1.5rem;">
                        <i class="fas fa-qrcode"></i> Gerar QR Code
                    </button>
                </form>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-list"></i> Meus Acessos</h2>
                <p style="color: #64748b; margin-bottom: 1rem;">Acessos gerados para visitantes da sua unidade.</p>
                <div id="listaAcessos"></div>
            </div>
        </div>
        
        <!-- ABA: PROTOCOLOS -->
        <div id="protocolos" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-box"></i> Meus Protocolos</h2>
                <p style="color: #64748b; margin-bottom: 1.5rem;">Acompanhe todos os protocolos de encomendas e entregas recebidas na portaria.</p>
                
                <!-- Filtros -->
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button onclick="filtrarProtocolos('')" class="btn-filtro active" id="filtroTodos">
                        <i class="fas fa-list"></i> Todos
                    </button>
                    <button onclick="filtrarProtocolos('pendente')" class="btn-filtro" id="filtroPendente">
                        <i class="fas fa-clock"></i> Pendentes
                    </button>
                    <button onclick="filtrarProtocolos('entregue')" class="btn-filtro" id="filtroEntregue">
                        <i class="fas fa-check"></i> Entregues
                    </button>
                </div>
                
                <!-- Lista de Protocolos -->
                <div id="listaProtocolos"></div>
            </div>
        </div>
        
        <!-- ABA: HIDR√îMETRO -->
        <div id="hidrometro" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-tachometer-alt"></i> Dados do Hidr√¥metro</h2>
                <div id="dadosHidrometro"></div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-history"></i> Hist√≥rico de Leituras</h2>
                <div id="historicoLeituras"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let token = null;
        let moradorId = null;
        let moradorNome = null;
        let sessaoVerificada = false;
        let tentativasVerificacao = 0;
        const MAX_TENTATIVAS = 3;
        let abaAtual = 'perfil';

        // ========== INICIALIZA√á√ÉO ==========
        (function() {
            console.log('üîÑ Iniciando portal...');
            
            token = localStorage.getItem('portal_token');
            moradorId = localStorage.getItem('morador_id');
            moradorNome = localStorage.getItem('morador_nome');
            
            console.log('üì¶ Token:', token ? token.substring(0, 20) + '...' : 'null');
            console.log('üì¶ Morador ID:', moradorId);
            
            if (!token || !moradorId) {
                console.log('‚ùå Sem token ou morador_id');
                redirecionarParaLogin('Sess√£o n√£o encontrada. Fa√ßa login novamente.');
                return;
            }
            
            verificarSessao();
        })();

        // ========== VERIFICAR SESS√ÉO ==========
        function verificarSessao() {
            tentativasVerificacao++;
            console.log(`üîç Verificando sess√£o (tentativa ${tentativasVerificacao}/${MAX_TENTATIVAS})...`);
            
            document.getElementById('loadingText').textContent = `Verificando sess√£o... (${tentativasVerificacao}/${MAX_TENTATIVAS})`;
            
            fetch('api/api_portal.php?action=verificar_sessao', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    console.log('‚úÖ Sess√£o v√°lida!');
                    sessaoVerificada = true;
                    inicializarPortal();
                } else {
                    console.log('‚ùå Sess√£o inv√°lida:', data.mensagem);
                    redirecionarParaLogin(data.mensagem || 'Sess√£o expirada');
                }
            })
            .catch(error => {
                console.error('‚ùå Erro ao verificar sess√£o:', error);
                if (tentativasVerificacao < MAX_TENTATIVAS) {
                    setTimeout(verificarSessao, 2000);
                } else {
                    redirecionarParaLogin('Erro ao conectar com o servidor.');
                }
            });
        }

        // ========== INICIALIZAR PORTAL ==========
        function inicializarPortal() {
            console.log('üöÄ Inicializando portal...');
            
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hide');
                document.getElementById('mainHeader').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('nomeUsuario').textContent = moradorNome || 'Morador';
                
                console.log('‚úÖ Portal inicializado!');
                
                // Carregar dados da aba inicial
                carregarPerfil();
            }, 500);
        }

        // ========== REDIRECIONAR PARA LOGIN ==========
        function redirecionarParaLogin(mensagem) {
            console.log('üîÑ Redirecionando para login:', mensagem);
            localStorage.clear();
            sessionStorage.setItem('mensagem_logout', mensagem);
            setTimeout(() => {
                window.location.href = 'login_morador.html';
            }, 1000);
        }

        // ========== LOGOUT ==========
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.clear();
                window.location.href = 'login_morador.html';
            }
        }

        // ========== ABRIR ABA ==========
        function abrirAba(aba) {
            // Atualizar tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.closest('.tab').classList.add('active');
            document.getElementById(aba).classList.add('active');
            
            abaAtual = aba;
            
            // Carregar dados da aba
            if (aba === 'perfil') carregarPerfil();
            if (aba === 'visitantes') {
                carregarVisitantes();
                carregarAcessos();
            }
            if (aba === 'protocolos') carregarProtocolos();
            if (aba === 'hidrometro') carregarHidrometro();
        }

        // ========== MOSTRAR ALERTA ==========
        function mostrarAlerta(mensagem, tipo) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${tipo} show">
                    <i class="fas fa-${tipo === 'error' ? 'exclamation-circle' : tipo === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    ${mensagem}
                </div>
            `;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
            
            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========================================
        // PERFIL
        // ========================================
        
        function carregarPerfil() {
            fetch('api/api_portal_morador.php?action=perfil', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    const morador = data.dados;
                    document.getElementById('perfilNome').textContent = morador.nome;
                    document.getElementById('perfilCpf').textContent = morador.cpf;
                    document.getElementById('perfilUnidade').textContent = morador.unidade;
                    document.getElementById('perfilEmail').textContent = morador.email;
                    document.getElementById('telefone').value = morador.telefone || '';
                    document.getElementById('celular').value = morador.celular || '';
                } else {
                    mostrarAlerta(data.mensagem, 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao carregar perfil:', error);
                mostrarAlerta('Erro ao carregar perfil', 'error');
            });
        }
        
        function atualizarTelefone(event) {
            event.preventDefault();
            
            const telefone = document.getElementById('telefone').value;
            const celular = document.getElementById('celular').value;
            
            fetch('api/api_portal_morador.php?action=perfil', {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ telefone, celular })
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    mostrarAlerta(data.mensagem, 'success');
                } else {
                    mostrarAlerta(data.mensagem, 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao atualizar telefone', 'error');
            });
        }
        
        function alterarSenha(event) {
            event.preventDefault();
            
            const senhaAtual = document.getElementById('senhaAtual').value;
            const senhaNova = document.getElementById('senhaNova').value;
            const senhaConfirmar = document.getElementById('senhaConfirmar').value;
            
            if (senhaNova !== senhaConfirmar) {
                mostrarAlerta('As senhas n√£o coincidem', 'error');
                return;
            }
            
            if (senhaNova.length < 6) {
                mostrarAlerta('A senha deve ter no m√≠nimo 6 caracteres', 'error');
                return;
            }
            
            fetch('api/api_portal_morador.php?action=perfil', {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ senha_atual: senhaAtual, senha_nova: senhaNova })
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    mostrarAlerta(data.mensagem, 'success');
                    document.getElementById('formSenha').reset();
                } else {
                    mostrarAlerta(data.mensagem, 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao alterar senha', 'error');
            });
        }

        // ========================================
        // VISITANTES
        // ========================================
        
        function carregarVisitantes() {
            // Carregar lista de visitantes
            fetch('api/api_portal_morador.php?action=visitantes', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('listaVisitantes');
                
                // Preencher select de visitantes para acessos
                const selectVisitante = document.getElementById('acessoVisitante');
                if (selectVisitante) {
                    selectVisitante.innerHTML = '<option value="">Selecione um visitante</option>';
                    if (data.sucesso && data.dados.length > 0) {
                        data.dados.forEach(v => {
                            const option = document.createElement('option');
                            option.value = v.id;
                            option.textContent = `${v.nome_completo} - ${v.documento}`;
                            selectVisitante.appendChild(option);
                        });
                    }
                }
                
                if (data.sucesso && data.dados.length > 0) {
                    let html = '<table><thead><tr><th>Nome</th><th>Documento</th><th>Telefone</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>';
                    
                    data.dados.forEach(visitante => {
                        html += `
                            <tr>
                                <td>${visitante.nome_completo}</td>
                                <td>${visitante.tipo_documento}: ${visitante.documento}</td>
                                <td>${visitante.celular || visitante.telefone || '-'}</td>
                                <td><span class="badge badge-${visitante.ativo ? 'success' : 'danger'}">${visitante.ativo ? 'Ativo' : 'Inativo'}</span></td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="excluirVisitante(${visitante.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>Nenhum visitante cadastrado</p></div>';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao carregar visitantes', 'error');
            });
        }
        
        function cadastrarVisitante(event) {
            event.preventDefault();
            
            const dados = {
                nome_completo: document.getElementById('visitanteNome').value,
                tipo_documento: document.getElementById('visitanteTipoDoc').value,
                documento: document.getElementById('visitanteDoc').value,
                telefone: document.getElementById('visitanteTelefone').value,
                celular: document.getElementById('visitanteCelular').value,
                email: document.getElementById('visitanteEmail').value,
                observacao: document.getElementById('visitanteObs').value
            };
            
            fetch('api/api_portal_morador.php?action=visitantes', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    mostrarAlerta(data.mensagem, 'success');
                    document.getElementById('formVisitante').reset();
                    carregarVisitantes();
                } else {
                    mostrarAlerta(data.mensagem, 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao cadastrar visitante', 'error');
            });
        }
        
        function excluirVisitante(id) {
            if (!confirm('Deseja realmente excluir este visitante?')) return;
            
            fetch(`api/api_portal_morador.php?action=visitantes&id=${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    mostrarAlerta(data.mensagem, 'success');
                    carregarVisitantes();
                } else {
                    mostrarAlerta(data.mensagem, 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao excluir visitante', 'error');
            });
        }
        
        // ========================================
        // ACESSOS
        // ========================================
        
        // Calcular dias de perman√™ncia
        document.getElementById('acessoDataInicial')?.addEventListener('change', calcularDiasAcesso);
        document.getElementById('acessoDataFinal')?.addEventListener('change', calcularDiasAcesso);
        
        function calcularDiasAcesso() {
            const dataInicial = document.getElementById('acessoDataInicial').value;
            const dataFinal = document.getElementById('acessoDataFinal').value;
            
            if (dataInicial && dataFinal) {
                const dt1 = new Date(dataInicial);
                const dt2 = new Date(dataFinal);
                
                if (dt2 >= dt1) {
                    const diffTime = Math.abs(dt2 - dt1);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    document.getElementById('acessoDiasNumero').textContent = diffDays;
                    document.getElementById('acessoDias').style.display = 'block';
                } else {
                    document.getElementById('acessoDias').style.display = 'none';
                    mostrarAlerta('Data final deve ser maior ou igual √† data inicial', 'error');
                }
            }
        }
        
        // Selecionar tipo de acesso
        function selecionarTipoAcessoPortal(tipo) {
            document.querySelectorAll('[name="acessoTipoAcesso"]').forEach(radio => {
                const label = radio.parentElement;
                if (radio.value === tipo) {
                    radio.checked = true;
                    label.style.borderColor = '#3b82f6';
                    label.style.backgroundColor = '#eff6ff';
                } else {
                    label.style.borderColor = '#e2e8f0';
                    label.style.backgroundColor = 'transparent';
                }
            });
        }
        
        // Salvar acesso
        function salvarAcesso(event) {
            event.preventDefault();
            
            const visitanteId = document.getElementById('acessoVisitante').value;
            const tipoVisitante = document.getElementById('acessoTipo').value;
            const placa = document.getElementById('acessoPlaca').value || null;
            const modelo = document.getElementById('acessoModelo').value || null;
            const cor = document.getElementById('acessoCor').value || null;
            const dataInicial = document.getElementById('acessoDataInicial').value;
            const dataFinal = document.getElementById('acessoDataFinal').value;
            const tipoAcesso = document.querySelector('[name="acessoTipoAcesso"]:checked')?.value;
            
            if (!visitanteId || !dataInicial || !dataFinal || !tipoAcesso) {
                mostrarAlerta('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            // Obter dados do morador logado
            const moradorId = sessionStorage.getItem('morador_id');
            const unidade = sessionStorage.getItem('morador_unidade');
            
            const dados = {
                visitante_id: visitanteId,
                tipo_visitante: tipoVisitante,
                placa: placa,
                modelo: modelo,
                cor: cor,
                data_inicial: dataInicial,
                data_final: dataFinal,
                tipo_acesso: tipoAcesso,
                morador_id: moradorId,
                unidade_destino: unidade
            };
            
            fetch('api/api_acessos_visitantes.php', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token 
                },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    mostrarAlerta('Acesso cadastrado com sucesso! QR Code gerado.', 'success');
                    document.getElementById('formAcesso').reset();
                    document.getElementById('acessoDias').style.display = 'none';
                    carregarAcessos();
                } else {
                    mostrarAlerta(data.mensagem, 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao cadastrar acesso', 'error');
            });
        }
        
        // Carregar acessos
        function carregarAcessos() {
            const moradorId = sessionStorage.getItem('morador_id');
            
            fetch(`api/api_acessos_visitantes.php?morador_id=${moradorId}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('listaAcessos');
                
                if (data.sucesso && data.dados.length > 0) {
                    let html = '<table><thead><tr><th>Visitante</th><th>Per√≠odo</th><th>Tipo</th><th>Ve√≠culo</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>';
                    
                    data.dados.forEach(acesso => {
                        const dataInicial = new Date(acesso.data_inicial).toLocaleDateString('pt-BR');
                        const dataFinal = new Date(acesso.data_final).toLocaleDateString('pt-BR');
                        const hoje = new Date();
                        const dtInicial = new Date(acesso.data_inicial);
                        const dtFinal = new Date(acesso.data_final);
                        const ativo = hoje >= dtInicial && hoje <= dtFinal && acesso.ativo;
                        
                        const badgeTipo = acesso.tipo_acesso === 'portaria' ? 'primary' : acesso.tipo_acesso === 'externo' ? 'warning' : 'success';
                        const veiculo = acesso.placa ? `${acesso.placa} - ${acesso.modelo || ''} ${acesso.cor || ''}` : '-';
                        
                        html += `
                            <tr>
                                <td>${acesso.visitante_nome}</td>
                                <td>${dataInicial} a ${dataFinal}<br><small>${acesso.dias_permanencia} dias</small></td>
                                <td><span class="badge badge-${badgeTipo}">${acesso.tipo_acesso.toUpperCase()}</span></td>
                                <td>${veiculo}</td>
                                <td><span class="badge badge-${ativo ? 'success' : 'danger'}">${ativo ? 'Ativo' : 'Inativo'}</span></td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="gerarQRCode(${acesso.id})" title="Gerar QR Code">
                                        <i class="fas fa-qrcode"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="excluirAcesso(${acesso.id})" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color:#64748b; text-align:center; padding:2rem;">Nenhum acesso cadastrado</p>';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
            });
        }
        
        // Gerar QR Code
        function gerarQRCode(id) {
            window.open(`api_acessos_visitantes.php?action=gerar_qrcode&id=${id}`, '_blank');
        }
        
        // Excluir acesso
        function excluirAcesso(id) {
            if (!confirm('Deseja realmente excluir este acesso?')) return;
            
            fetch(`api/api_acessos_visitantes.php?id=${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    mostrarAlerta(data.mensagem, 'success');
                    carregarAcessos();
                } else {
                    mostrarAlerta(data.mensagem, 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao excluir acesso', 'error');
            });
        }

        // ========================================
        // HIDR√îMETRO
        // ========================================
        
        let dadosHidrometro = null;
        
        function carregarHidrometro() {
            fetch('api/api_morador_hidrometro.php', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    const { todos_hidrometros, hidrometro_ativo, leituras } = data.dados;
                    const hidrometros = todos_hidrometros || [];
                    
                    // Dados do hidr√¥metro ativo
                    if (hidrometro_ativo) {
                        let htmlHidro = `
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label"><i class="fas fa-microchip"></i> N√∫mero do Hidr√¥metro</div>
                                    <div class="info-value">${hidrometro_ativo.numero_hidrometro || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label"><i class="fas fa-lock"></i> N√∫mero do Lacre</div>
                                    <div class="info-value">${hidrometro_ativo.numero_lacre || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label"><i class="fas fa-calendar"></i> Data da Troca/Instala√ß√£o</div>
                                    <div class="info-value">${hidrometro_ativo.data_instalacao || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label"><i class="fas fa-check-circle"></i> Status</div>
                                    <div class="info-value"><span class="badge badge-success">Ativo</span></div>
                                </div>
                            </div>
                        `;
                        
                        // Mostrar hidr√¥metros anteriores se houver
                        if (hidrometros.length > 1) {
                            htmlHidro += '<div style="margin-top: 1.5rem; padding: 1rem; background: #f0f9ff; border-left: 4px solid #0284c7; border-radius: 8px;">';
                            htmlHidro += '<small style="color: #0369a1;"><i class="fas fa-info-circle"></i> <strong>Hist√≥rico:</strong> Voc√™ possui ' + (hidrometros.length - 1) + ' hidr√¥metro(s) anterior(es) com leituras registradas.</small>';
                            htmlHidro += '</div>';
                        }
                        
                        document.getElementById('dadosHidrometro').innerHTML = htmlHidro;
                    } else {
                        document.getElementById('dadosHidrometro').innerHTML = '<div class="empty-state"><i class="fas fa-tint"></i><p>Nenhum hidr√¥metro ativo encontrado</p></div>';
                    }
                    
                    // Hist√≥rico de leituras
                    if (leituras.length > 0) {
                        let htmlLeituras = `
                            <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data da Leitura</th>
                                        <th>Hidr√¥metro (N√∫mero)</th>
                                        <th>Leitura Anterior (m¬≥)</th>
                                        <th>Leitura Atual (m¬≥)</th>
                                        <th>Consumo (m¬≥)</th>
                                        <th>Valor a Pagar</th>
                                        <th>Status do Hidr√¥metro</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        leituras.forEach(leitura => {
                            const statusBadge = leitura.hidrometro_ativo == 1 
                                ? '<span class="badge badge-success"><i class="fas fa-check"></i> Ativo</span>' 
                                : '<span class="badge badge-secondary"><i class="fas fa-times"></i> Inativo</span>';
                            
                            const valorFormatado = parseFloat(leitura.valor_total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                            const consumoFormatado = parseFloat(leitura.consumo).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            const leituraAnteriorFormatada = parseFloat(leitura.leitura_anterior).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            const leituraAtualFormatada = parseFloat(leitura.leitura_atual).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            
                            htmlLeituras += `
                                <tr>
                                    <td><strong>${leitura.data_leitura}</strong></td>
                                    <td>
                                        <div>${leitura.numero_hidrometro}</div>
                                        <small style="color: #64748b; display: block; margin-top: 0.25rem;">Lacre: ${leitura.numero_lacre || 'N/A'}</small>
                                    </td>
                                    <td>${leituraAnteriorFormatada}</td>
                                    <td>${leituraAtualFormatada}</td>
                                    <td><strong>${consumoFormatado}</strong></td>
                                    <td><strong style="color: #10b981;">${valorFormatado}</strong></td>
                                    <td>${statusBadge}</td>
                                </tr>
                            `;
                        });
                        
                        htmlLeituras += '</tbody></table></div>';
                        document.getElementById('historicoLeituras').innerHTML = htmlLeituras;
                    } else {
                        document.getElementById('historicoLeituras').innerHTML = '<div class="empty-state"><i class="fas fa-tint"></i><p>Nenhuma leitura registrada</p></div>';
                    }
                } else {
                    document.getElementById('dadosHidrometro').innerHTML = '<div class="empty-state"><i class="fas fa-tint"></i><p>' + data.mensagem + '</p></div>';
                    document.getElementById('historicoLeituras').innerHTML = '';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao carregar dados do hidr√¥metro', 'error');
            });
        }
        
        
        // ========================================
        // PROTOCOLOS
        // ========================================
        
        let filtroProtocoloAtual = '';
        
        function carregarProtocolos(filtro = '') {
            filtroProtocoloAtual = filtro;
            
            const url = filtro ? `api_morador_protocolos.php?status=${filtro}` : 'api_morador_protocolos.php';
            
            fetch(url)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('listaProtocolos');
                
                if (data.sucesso && data.dados.length > 0) {
                    let html = '<div style="display: grid; gap: 1rem;">';
                    
                    data.dados.forEach(protocolo => {
                        const statusClass = protocolo.status === 'entregue' ? 'success' : 'warning';
                        const statusIcon = protocolo.status === 'entregue' ? 'check-circle' : 'clock';
                        const statusText = protocolo.status === 'entregue' ? 'Entregue' : 'Pendente';
                        
                        html += `
                            <div class="protocolo-card" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid ${statusClass === 'success' ? '#10b981' : '#f59e0b'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="font-size: 1.1rem; font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">
                                            <i class="fas fa-box"></i> Protocolo #${protocolo.id}
                                        </h3>
                                        <p style="color: #64748b; font-size: 0.9rem;">${protocolo.unidade_nome || 'N/A'}</p>
                                    </div>
                                    <span class="badge badge-${statusClass}" style="padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                                        <i class="fas fa-${statusIcon}"></i> ${statusText}
                                    </span>
                                </div>
                                
                                <div style="display: grid; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div class="info-row" style="display: flex; align-items: start; gap: 0.5rem;">
                                        <i class="fas fa-box" style="color: #3b82f6; margin-top: 0.25rem; width: 20px;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Descri√ß√£o</div>
                                            <div style="font-weight: 500; color: #1e293b;">${protocolo.descricao_mercadoria || 'N√£o informado'}</div>
                                        </div>
                                    </div>
                                    
                                    ${protocolo.codigo_nf ? `
                                    <div class="info-row" style="display: flex; align-items: start; gap: 0.5rem;">
                                        <i class="fas fa-barcode" style="color: #3b82f6; margin-top: 0.25rem; width: 20px;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">C√≥digo NF</div>
                                            <div style="font-weight: 500; color: #1e293b;">${protocolo.codigo_nf}</div>
                                        </div>
                                    </div>
                                    ` : ''}
                                    
                                    <div class="info-row" style="display: flex; align-items: start; gap: 0.5rem;">
                                        <i class="fas fa-calendar" style="color: #3b82f6; margin-top: 0.25rem; width: 20px;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Recebido em</div>
                                            <div style="font-weight: 500; color: #1e293b;">${protocolo.data_hora_recebimento}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="info-row" style="display: flex; align-items: start; gap: 0.5rem;">
                                        <i class="fas fa-user" style="color: #3b82f6; margin-top: 0.25rem; width: 20px;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Recebido por (Portaria)</div>
                                            <div style="font-weight: 500; color: #1e293b;">${protocolo.recebedor_portaria || 'N√£o informado'}</div>
                                        </div>
                                    </div>
                                    
                                    ${protocolo.status === 'entregue' ? `
                                    <div class="info-row" style="display: flex; align-items: start; gap: 0.5rem;">
                                        <i class="fas fa-check-circle" style="color: #10b981; margin-top: 0.25rem; width: 20px;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Entregue em</div>
                                            <div style="font-weight: 500; color: #1e293b;">${protocolo.data_hora_entrega || 'N√£o informado'}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="info-row" style="display: flex; align-items: start; gap: 0.5rem;">
                                        <i class="fas fa-user-check" style="color: #10b981; margin-top: 0.25rem; width: 20px;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">Recebido por (Morador)</div>
                                            <div style="font-weight: 500; color: #1e293b;">${protocolo.nome_recebedor_morador || 'N√£o informado'}</div>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-box"></i><p>Nenhum protocolo encontrado</p></div>';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar protocolos:', error);
                document.getElementById('listaProtocolos').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar protocolos</p></div>';
            });
        }
        
        function filtrarProtocolos(filtro) {
            // Atualizar bot√µes ativos
            document.querySelectorAll('.btn-filtro').forEach(btn => btn.classList.remove('active'));
            
            if (filtro === '') {
                document.getElementById('filtroTodos').classList.add('active');
            } else if (filtro === 'pendente') {
                document.getElementById('filtroPendente').classList.add('active');
            } else if (filtro === 'entregue') {
                document.getElementById('filtroEntregue').classList.add('active');
            }
            
            // Carregar protocolos com filtro
            carregarProtocolos(filtro);
        }
    </script>
</body>
</html>
