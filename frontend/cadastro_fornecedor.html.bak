<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Fornecedor - Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
.container { max-width: 600px; margin: 0 auto; padding: 20px; }
.card { background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.card h2 { margin-bottom: 10px; color: #333; }
.card p { color: #666; margin-bottom: 20px; }
.btn { padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
.btn-primary { background: #007bff; color: white; }
.btn-primary:hover { background: #0056b3; }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }
.btn-secondary { background: #6c757d; color: white; text-decoration: none; display: inline-block; }
.btn-secondary:hover { background: #5a6268; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
.form-control { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px; transition: all 0.3s; }
.form-control:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
.form-control.error { border-color: #dc3545; }
.error-message { color: #dc3545; font-size: 12px; margin-top: 5px; display: none; }
.error-message.show { display: block; }
.alert { padding: 15px; border-radius: 4px; margin-bottom: 20px; display: none; }
.alert.show { display: block; }
.alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.form-row.full { grid-template-columns: 1fr; }
.loading { display: none; text-align: center; }
.spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.required { color: #dc3545; }
.form-buttons { display: flex; gap: 10px; margin-top: 30px; }
.form-buttons .btn { flex: 1; }
hr { border: none; border-top: 1px solid #ddd; margin: 20px 0; }
@media (max-width: 600px) {
    .container { padding: 10px; }
    .card { padding: 20px; }
    .form-row { grid-template-columns: 1fr; }
}
</style>

    <script src="js/sessao_manager.js"></script>
</head>
<body>
    <div class="container">
        <div class="card">
            <h2><i class="fas fa-user-plus"></i> Cadastro de Fornecedor</h2>
            <p>Preencha os dados para se cadastrar no marketplace</p>
            <hr>
            
            <div id="alertContainer"></div>
            
            <form id="formCadastro">
                <div class="form-row">
                    <div class="form-group">
                        <label>CPF/CNPJ <span class="required">*</span></label>
                        <input type="text" name="cpf_cnpj" class="form-control" placeholder="000.000.000-00 ou 00.000.000/0000-00" required>
                        <div class="error-message">CPF/CNPJ é obrigatório</div>
                    </div>
                    <div class="form-group">
                        <label>Ramo de Atividade <span class="required">*</span></label>
                        <select name="ramo_atividade_id" class="form-control" required id="selectRamo">
                            <option value="">Carregando...</option>
                        </select>
                        <div class="error-message">Ramo de atividade é obrigatório</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Nome do Estabelecimento <span class="required">*</span></label>
                    <input type="text" name="nome_estabelecimento" class="form-control" placeholder="Ex: Padaria da Liberdade" required>
                    <div class="error-message">Nome do estabelecimento é obrigatório</div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>E-mail <span class="required">*</span></label>
                        <input type="email" name="email" class="form-control" placeholder="seu@email.com" required>
                        <div class="error-message">E-mail válido é obrigatório</div>
                    </div>
                    <div class="form-group">
                        <label>Senha <span class="required">*</span></label>
                        <input type="password" name="senha" class="form-control" placeholder="Mínimo 6 caracteres" required>
                        <div class="error-message">Senha deve ter no mínimo 6 caracteres</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" name="telefone" class="form-control" placeholder="(11) 99999-9999">
                    </div>
                    <div class="form-group">
                        <label>Nome do Responsável</label>
                        <input type="text" name="nome_responsavel" class="form-control" placeholder="Nome completo">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Endereço</label>
                    <textarea name="endereco" class="form-control" rows="3" placeholder="Rua, número, complemento, bairro, cidade"></textarea>
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Cadastrar
                    </button>
                    <a href="login_fornecedor.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== VARIÁVEIS GLOBAIS ==========
        const DEBUG = true;
        
        function log(msg, data = null) {
            if (DEBUG) {
                console.log('[Cadastro Fornecedor]', msg, data || '');
            }
        }
        
        // ========== MOSTRAR ALERTA ==========
        function mostrarAlerta(mensagem, tipo = 'info') {
            log('Mostrando alerta:', { mensagem, tipo });
            
            const container = document.getElementById('alertContainer');
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo} show`;
            alerta.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'danger' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${mensagem}
            `;
            
            container.innerHTML = '';
            container.appendChild(alerta);
            
            // Auto-remover após 5 segundos (exceto erro)
            if (tipo !== 'danger') {
                setTimeout(() => {
                    alerta.remove();
                }, 5000);
            }
        }
        
        // ========== CARREGAR RAMOS DE ATIVIDADE ==========
        async function carregarRamos() {
            try {
                log('Carregando ramos de atividade...');
                
                const res = await fetch('api/api_ramos_atividade.php?acao=listar');
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                log('Ramos carregados:', data);
                
                const select = document.getElementById('selectRamo');
                
                if (data.sucesso && data.dados && data.dados.length > 0) {
                    select.innerHTML = '<option value="">Selecione um ramo de atividade...</option>';
                    
                    data.dados.forEach(ramo => {
                        const option = document.createElement('option');
                        option.value = ramo.id;
                        option.textContent = ramo.nome;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Erro ao carregar ramos</option>';
                    mostrarAlerta('Erro ao carregar ramos de atividade', 'danger');
                }
            } catch (error) {
                log('Erro ao carregar ramos:', error);
                console.error('Erro:', error);
                mostrarAlerta('Erro ao carregar ramos de atividade: ' + error.message, 'danger');
            }
        }
        
        // ========== VALIDAR FORMULÁRIO ==========
        function validarFormulario(formData) {
            log('Validando formulário...');
            
            const cpf_cnpj = formData.get('cpf_cnpj')?.trim() || '';
            const nome = formData.get('nome_estabelecimento')?.trim() || '';
            const ramo = formData.get('ramo_atividade_id')?.trim() || '';
            const email = formData.get('email')?.trim() || '';
            const senha = formData.get('senha')?.trim() || '';
            
            if (!cpf_cnpj) {
                mostrarAlerta('CPF/CNPJ é obrigatório', 'danger');
                return false;
            }
            
            if (!nome) {
                mostrarAlerta('Nome do estabelecimento é obrigatório', 'danger');
                return false;
            }
            
            if (!ramo) {
                mostrarAlerta('Ramo de atividade é obrigatório', 'danger');
                return false;
            }
            
            if (!email || !email.includes('@')) {
                mostrarAlerta('E-mail válido é obrigatório', 'danger');
                return false;
            }
            
            if (senha.length < 6) {
                mostrarAlerta('Senha deve ter no mínimo 6 caracteres', 'danger');
                return false;
            }
            
            log('Validação passou');
            return true;
        }
        
        // ========== ENVIAR FORMULÁRIO ==========
        document.getElementById('formCadastro').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            log('Enviando formulário...');
            
            const form = e.target;
            const formData = new FormData(form);
            
            // Validar antes de enviar
            if (!validarFormulario(formData)) {
                return;
            }
            
            // Adicionar ação
            formData.append('acao', 'cadastrar');
            
            // Desabilitar botão
            const btnSubmit = form.querySelector('button[type="submit"]');
            const btnOriginalText = btnSubmit.innerHTML;
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';
            
            try {
                log('Enviando dados para API...');
                
                const res = await fetch('api/api_fornecedores.php', {
                    method: 'POST',
                    body: formData
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                log('Resposta da API:', data);
                
                if (data.sucesso) {
                    mostrarAlerta(data.mensagem || 'Cadastro realizado com sucesso!', 'success');
                    
                    // Limpar formulário
                    form.reset();
                    
                    // Redirecionar após 2 segundos
                    setTimeout(() => {
                        window.location.href = 'login_fornecedor.html';
                    }, 2000);
                } else {
                    mostrarAlerta(data.mensagem || 'Erro ao cadastrar fornecedor', 'danger');
                }
            } catch (error) {
                log('Erro ao enviar:', error);
                console.error('Erro:', error);
                mostrarAlerta('Erro ao cadastrar: ' + error.message, 'danger');
            } finally {
                // Reabilitar botão
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = btnOriginalText;
            }
        });
        
        // ========== INICIALIZAR ==========
        document.addEventListener('DOMContentLoaded', () => {
            log('Página carregada, iniciando...');
            carregarRamos();
        });
    </script>
</body>
</html>
