<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios de Estoque - Serra da Liberdade</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { position: fixed; top: 0; left: 0; width: 260px; height: 100vh; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 2rem 0; overflow-y: auto; z-index: 1000; transition: transform 0.3s; }
        .sidebar h1 { color: #fff; font-size: 1.3rem; text-align: center; margin-bottom: 2rem; }
        .nav-menu { list-style: none; padding: 1rem; }
        .nav-item { margin-bottom: 0.5rem; }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; color: #cbd5e1; text-decoration: none; border-radius: 8px; transition: all 0.2s; }
        .nav-link:hover, .nav-link.active { background: rgba(255, 255, 255, 0.1); color: #fff; }
        .nav-link i { margin-right: 0.75rem; width: 20px; }
        .menu-toggle { display: none; position: fixed; top: 1rem; left: 1rem; z-index: 1001; background: #1e293b; color: #fff; border: none; padding: 0.75rem; border-radius: 8px; cursor: pointer; }
        .main-content { margin-left: 260px; padding: 2rem; width: 100%; }
        .header { background: #fff; padding: 1.5rem 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        .submenu { background: #fff; padding: 1rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); display: flex; gap: 1rem; flex-wrap: wrap; }
        .submenu a { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: #f1f5f9; color: #334155; text-decoration: none; border-radius: 8px; transition: 0.2s; }
        .submenu a:hover, .submenu a.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .section { background: #fff; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        .section-title { font-size: 1.3rem; color: #1e293b; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.5rem; color: #334155; font-weight: 500; }
        .form-group input, .form-group select { padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .btn-secondary { background: #64748b; color: #fff; }
        .btn-secondary:hover { background: #475569; }
        .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; color: #334155; font-weight: 600; white-space: nowrap; }
        tr:hover { background: #f8fafc; }
        .badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 500; }
        .badge-entrada { background: #d1fae5; color: #065f46; }
        .badge-saida { background: #fee2e2; color: #991b1b; }
        .hidden { display: none; }
        .empty-state { text-align: center; padding: 3rem; color: #64748b; }
        .empty-state i { font-size: 4rem; margin-bottom: 1rem; opacity: 0.3; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .menu-toggle { display: block; }
            .main-content { margin-left: 0; padding: 1rem; }
            .header { padding: 1rem; }
            .submenu { flex-direction: column; }
            .submenu a { justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            .btn-group { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
    <script src="js/sessao_manager.js"></script>
</head>
<body>
    <button class="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
    <div class="main-container">
        <nav class="sidebar" id="sidebar">
            <h1>Serra da Liberdade</h1>
            <ul class="nav-menu">
                <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li class="nav-item"><a href="moradores.html" class="nav-link"><i class="fas fa-users"></i> Moradores</a></li>
                <li class="nav-item"><a href="veiculos.html" class="nav-link"><i class="fas fa-car"></i> Veículos</a></li>
                <li class="nav-item"><a href="visitantes.html" class="nav-link"><i class="fas fa-user-friends"></i> Visitantes</a></li>
                <li class="nav-item"><a href="registro.html" class="nav-link"><i class="fas fa-clipboard-list"></i> Registro Manual</a></li>
                <li class="nav-item"><a href="acesso.html" class="nav-link"><i class="fas fa-door-open"></i> Controle de Acesso</a></li>
                <li class="nav-item"><a href="relatorios.html" class="nav-link"><i class="fas fa-file-alt"></i> Relatórios</a></li>
                <li class="nav-item"><a href="configuracao.html" class="nav-link"><i class="fas fa-cog"></i> Configurações</a></li>
                <li class="nav-item"><a href="manutencao.html" class="nav-link"><i class="fas fa-tools"></i> Manutenção</a></li>
                <li class="nav-item"><a href="administrativa.html" class="nav-link"><i class="fas fa-briefcase"></i> Administrativo</a></li>
            </ul>
        </nav>
        <main class="main-content">
            <header class="header">
                <h1><i class="fas fa-chart-bar"></i> Relatórios de Estoque</h1>
            </header>
            
            <nav class="submenu">
                <a href="estoque.html"><i class="fas fa-boxes"></i> Produtos</a>
                <a href="entrada_estoque.html"><i class="fas fa-arrow-down"></i> Entrada</a>
                <a href="saida_estoque.html"><i class="fas fa-arrow-up"></i> Saída</a>
                <a href="relatorio_estoque.html" class="active"><i class="fas fa-chart-bar"></i> Relatórios</a>
            </nav>

            <div class="section">
                <h3 class="section-title"><i class="fas fa-filter"></i> Filtros de Relatório</h3>
                <form id="form-filtros">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tipo_relatorio">Tipo de Relatório</label>
                            <select id="tipo_relatorio" name="tipo_relatorio">
                                <option value="movimentacoes">Histórico de Movimentações</option>
                                <option value="saldo_atual">Saldo de Estoque Atual</option>
                                <option value="saidas_morador">Saídas por Morador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="data_inicio">Data Início</label>
                            <input type="date" id="data_inicio" name="data_inicio">
                        </div>
                        <div class="form-group">
                            <label for="data_fim">Data Fim</label>
                            <input type="date" id="data_fim" name="data_fim">
                        </div>
                        <div class="form-group">
                            <label for="produto_filtro">Produto</label>
                            <select id="produto_filtro" name="produto_id">
                                <option value="">Todos os produtos</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Gerar Relatório</button>
                </form>
            </div>

            <div class="section">
                <div class="section-title">
                    <h3 id="report-title"><i class="fas fa-table"></i> Resultados</h3>
                    <div class="btn-group">
                        <button id="export-pdf" class="btn btn-secondary" onclick="exportarPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                        <button id="export-excel" class="btn btn-secondary" onclick="exportarExcel()"><i class="fas fa-file-excel"></i> Exportar Excel</button>
                    </div>
                </div>
                <div class="table-container">
                    <div id="report-content">
                        <div class="empty-state">
                            <i class="fas fa-chart-bar"></i>
                            <p>Selecione os filtros e clique em "Gerar Relatório" para visualizar os dados</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'api_estoque.php';
        let dadosRelatorio = [];
        let tipoRelatorioAtual = '';

        document.addEventListener('DOMContentLoaded', () => {
            carregarProdutosFiltro();
            document.getElementById('form-filtros').addEventListener('submit', gerarRelatorio);
        });

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        async function carregarProdutosFiltro() {
            try {
                const response = await fetch(`${API_URL}?action=get_products`);
                const products = await response.json();
                const select = document.getElementById('produto_filtro');
                select.innerHTML = '<option value="">Todos os produtos</option>';
                products.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar produtos para filtro:', error);
            }
        }

        async function gerarRelatorio(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            tipoRelatorioAtual = formData.get('tipo_relatorio');
            
            const params = new URLSearchParams();
            params.append('action', 'get_report');
            for (const [key, value] of formData.entries()) {
                if (value) params.append(key, value);
            }

            try {
                const response = await fetch(`${API_URL}?${params.toString()}`);
                dadosRelatorio = await response.json();
                exibirRelatorio(dadosRelatorio, tipoRelatorioAtual);
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                document.getElementById('report-content').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erro ao gerar relatório</p></div>';
            }
        }

        function exibirRelatorio(data, tipo) {
            const contentDiv = document.getElementById('report-content');
            
            if (!data || data.length === 0) {
                contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>Nenhum resultado encontrado para os filtros selecionados</p></div>';
                return;
            }

            let headers = [];
            let titulo = '';

            switch (tipo) {
                case 'movimentacoes':
                    headers = ['Data/Hora', 'Produto', 'Tipo', 'Quantidade', 'Destino/Origem', 'Observação'];
                    titulo = 'Histórico de Movimentações';
                    break;
                case 'saldo_atual':
                    headers = ['Código', 'Produto', 'Categoria', 'Estoque Atual', 'Un. Medida', 'Preço Unit.', 'Valor Total'];
                    titulo = 'Saldo de Estoque Atual';
                    break;
                case 'saidas_morador':
                    headers = ['Data', 'Morador', 'Unidade', 'Produto', 'Quantidade', 'Observação'];
                    titulo = 'Saídas por Morador';
                    break;
            }

            document.getElementById('report-title').innerHTML = `<i class="fas fa-table"></i> ${titulo}`;

            let html = '<table id="report-table"><thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';

            data.forEach(item => {
                html += '<tr>';
                Object.values(item).forEach(val => {
                    if (typeof val === 'string' && (val.toLowerCase() === 'entrada' || val.toLowerCase() === 'saída')) {
                        html += `<td><span class="badge badge-${val.toLowerCase() === 'entrada' ? 'entrada' : 'saida'}">${val}</span></td>`;
                    } else {
                        html += `<td>${val || '-'}</td>`;
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            contentDiv.innerHTML = html;
        }

        function exportarPDF() {
            if (!dadosRelatorio || dadosRelatorio.length === 0) {
                alert('Nenhum dado para exportar. Gere um relatório primeiro.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            const titulo = document.getElementById('report-title').textContent;
            
            doc.setFontSize(16);
            doc.text(titulo, 14, 15);
            
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 22);

            const table = document.getElementById('report-table');
            if (table) {
                doc.autoTable({
                    html: '#report-table',
                    startY: 28,
                    headStyles: { fillColor: [30, 41, 59], textColor: [255, 255, 255] },
                    styles: { fontSize: 8 },
                    margin: { top: 28 }
                });
            }

            doc.save(`relatorio_estoque_${new Date().getTime()}.pdf`);
        }

        function exportarExcel() {
            if (!dadosRelatorio || dadosRelatorio.length === 0) {
                alert('Nenhum dado para exportar. Gere um relatório primeiro.');
                return;
            }

            const table = document.getElementById('report-table');
            if (!table) return;

            const wb = XLSX.utils.table_to_book(table, { sheet: "Relatório" });
            XLSX.writeFile(wb, `relatorio_estoque_${new Date().getTime()}.xlsx`);
        }
    </script>
    <!-- Proteção de Login -->
    <script src="js/auth-guard.js"></script>
    <script src="js/user-display.js"></script>
</body>
</html>

