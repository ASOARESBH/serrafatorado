<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Morador - Serra da Liberdade</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ESTILOS MANTIDOS DO ORIGINAL */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-screen.hide { display: none; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            color: #fff;
            margin-top: 1rem;
            font-size: 1.1rem;
        }
        
        /* Header */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 1.5rem 2rem; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; }
        .header h1 i { margin-right: 0.5rem; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-name { font-size: 0.95rem; }
        .btn-logout { background: rgba(255, 255, 255, 0.2); padding: 0.5rem 1rem; border: none; border-radius: 8px; color: #fff; cursor: pointer; transition: 0.2s; }
        .btn-logout:hover { background: rgba(255, 255, 255, 0.3); }
        
        /* Container */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        
        /* Alert */
        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: none; }
        .alert.show { display: block; }
        .alert-success { background: #dcfce7; color: #166534; border-left: 4px solid #22c55e; }
        .alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 1rem; }
            .header-content { flex-direction: column; gap: 1rem; }
        }
    </style>
    <script src="js/sessao_manager.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text">Verificando sess√£o...</div>
    </div>

    <!-- Header -->
    <header class="header" style="display:none;" id="mainHeader">
        <div class="header-content">
            <h1><i class="fas fa-home"></i> Portal do Morador</h1>
            <div class="user-info">
                <span class="user-name"><i class="fas fa-user"></i> <span id="nomeUsuario">Carregando...</span></span>
                <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </div>
    </header>

    <!-- Container -->
    <div class="container" style="display:none;" id="mainContainer">
        <div id="alertContainer"></div>
        
        <h2>Bem-vindo ao Portal do Morador!</h2>
        <p>Seu portal est√° carregando...</p>
        
        <!-- AQUI VIRIAM AS ABAS E CONTE√öDO DO PORTAL -->
    </div>

    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let token = null;
        let moradorId = null;
        let moradorNome = null;
        let sessaoVerificada = false;

        // ========== INICIALIZA√á√ÉO ==========
        (function() {
            console.log('üîÑ Iniciando portal...');
            
            // Obter dados do localStorage
            token = localStorage.getItem('portal_token');
            moradorId = localStorage.getItem('morador_id');
            moradorNome = localStorage.getItem('morador_nome');
            
            console.log('üì¶ Token:', token ? token.substring(0, 10) + '...' : 'null');
            console.log('üì¶ Morador ID:', moradorId);
            console.log('üì¶ Morador Nome:', moradorNome);
            
            // Verificar se tem token
            if (!token || !moradorId) {
                console.log('‚ùå Sem token ou morador_id');
                redirecionar ParaLogin('Sess√£o n√£o encontrada. Fa√ßa login novamente.');
                return;
            }
            
            // Verificar sess√£o no servidor
            verificarSessao();
        })();

        // ========== VERIFICAR SESS√ÉO ==========
        function verificarSessao() {
            console.log('üîç Verificando sess√£o no servidor...');
            
            fetch('../api/api_portal.php?action=verificar_sessao', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('üì° Status da resposta:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üì® Resposta da API:', data);
                
                if (data.sucesso) {
                    console.log('‚úÖ Sess√£o v√°lida!');
                    sessaoVerificada = true;
                    inicializarPortal();
                } else {
                    console.log('‚ùå Sess√£o inv√°lida:', data.mensagem);
                    redirecionarParaLogin(data.mensagem || 'Sess√£o expirada');
                }
            })
            .catch(error => {
                console.error('‚ùå Erro ao verificar sess√£o:', error);
                redirecionarParaLogin('Erro ao conectar com o servidor');
            });
        }

        // ========== INICIALIZAR PORTAL ==========
        function inicializarPortal() {
            console.log('üöÄ Inicializando portal...');
            
            // Esconder loading
            document.getElementById('loadingScreen').classList.add('hide');
            
            // Mostrar conte√∫do
            document.getElementById('mainHeader').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'block';
            
            // Atualizar nome do usu√°rio
            document.getElementById('nomeUsuario').textContent = moradorNome || 'Morador';
            
            // Carregar dados do portal
            carregarDadosPortal();
            
            console.log('‚úÖ Portal inicializado com sucesso!');
        }

        // ========== CARREGAR DADOS DO PORTAL ==========
        function carregarDadosPortal() {
            console.log('üì• Carregando dados do portal...');
            
            // Aqui voc√™ pode carregar:
            // - Perfil do morador
            // - Hidrometro
            // - Ve√≠culos
            // - Visitantes
            // etc.
            
            mostrarAlerta('Portal carregado com sucesso!', 'success');
        }

        // ========== REDIRECIONAR PARA LOGIN ==========
        function redirecionarParaLogin(mensagem) {
            console.log('üîÑ Redirecionando para login:', mensagem);
            
            // Limpar localStorage
            localStorage.clear();
            
            // Salvar mensagem para exibir no login
            sessionStorage.setItem('mensagem_logout', mensagem);
            
            // Redirecionar
            window.location.href = 'login_morador.html';
        }

        // ========== LOGOUT ==========
        function logout() {
            if (!confirm('Deseja realmente sair do portal?')) {
                return;
            }
            
            console.log('üëã Fazendo logout...');
            
            fetch('../api/api_portal.php?action=logout', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('üì® Resposta do logout:', data);
                redirecionarParaLogin('Logout realizado com sucesso');
            })
            .catch(error => {
                console.error('‚ùå Erro no logout:', error);
                redirecionarParaLogin('Logout realizado');
            });
        }

        // ========== MOSTRAR ALERTA ==========
        function mostrarAlerta(mensagem, tipo = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo} show`;
            alert.innerHTML = `<i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${mensagem}`;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // ========== PREVENIR NAVEGA√á√ÉO SEM SESS√ÉO ==========
        window.addEventListener('beforeunload', function() {
            if (!sessaoVerificada) {
                localStorage.clear();
            }
        });
    </script>
</body>
</html>

